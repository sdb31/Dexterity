
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>MotoTrak_Supination_Viewer</title><meta name="generator" content="MATLAB 8.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-04-29"><meta name="DC.source" content="MotoTrak_Supination_Viewer.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#3">This function displays the force and IR traces from the selected trial.</a></li><li><a href="#6">This function executes when the user interacts with the slider.</a></li><li><a href="#9">This function executes when the user interacts with the slider.</a></li><li><a href="#12">This subfunction creates the GUI.</a></li><li><a href="#15">This function is called whenever the main figure is resized.</a></li><li><a href="#18">This function finds peaks in the signal, accounting for equality of contiguous samples.</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> MotoTrak_Supination_Viewer
</pre><pre class="codeinput">[files, path] = uigetfile(<span class="string">'*.ArdyMotor'</span>,<span class="string">'Select MotoTrak Files'</span>,<span class="keyword">...</span>
    <span class="string">'multiselect'</span>,<span class="string">'on'</span>);                                                    <span class="comment">%Have the user pick an input *.ArdyMotor file or files.</span>
<span class="keyword">if</span> ~iscell(files) &amp;&amp; files(1) == 0                                          <span class="comment">%If no file was selected...</span>
    <span class="keyword">return</span>                                                                  <span class="comment">%Exit the function.</span>
<span class="keyword">end</span>
cd(path);                                                                   <span class="comment">%Change the current directory to the specified folder.</span>
<span class="keyword">if</span> ischar(files)                                                            <span class="comment">%If only one file was selected...</span>
    files = {files};                                                        <span class="comment">%Convert the string to a cell array.</span>
<span class="keyword">end</span>

<span class="keyword">for</span> f = 1:length(files)                                                     <span class="comment">%Step through each file.</span>
    handles = ArdyMotorFileRead(files{f});                                  <span class="comment">%Read in the data from the *.ArdyMotor file.</span>
    <span class="keyword">if</span> ~isfield(handles,<span class="string">'trial'</span>) || isempty(handles.trial)                  <span class="comment">%If there's no trials in this data file...</span>
        warning(<span class="string">'ARDYMOTOR2TEXT:NoTrials'</span>,[<span class="string">'WARNING FROM '</span><span class="keyword">...</span>
            <span class="string">'ARDYMOTOR2TEXT: The file "'</span> files{f} <span class="string">'" has zero trials '</span><span class="keyword">...</span>
            <span class="string">'and will be skipped.'</span>]);                                       <span class="comment">%Show a warning.</span>
        <span class="keyword">continue</span>                                                            <span class="comment">%Skip to the next file.</span>
    <span class="keyword">end</span>
    handles.file = files{f};                                                <span class="comment">%Save the filename.</span>
    handles.ir_thresh = [1023, 0];                                          <span class="comment">%Create a matrix to hold the IR signal bounds.</span>
    <span class="keyword">for</span> t = 1:length(handles.trial)                                         <span class="comment">%Step through each trial.</span>
        handles.ir_thresh(1) = <span class="keyword">...</span>
            min([handles.trial(t).ir; handles.ir_thresh(1)]);               <span class="comment">%Find the new minimum for each trial.</span>
        handles.ir_thresh(2) = <span class="keyword">...</span>
            max([handles.trial(t).ir; handles.ir_thresh(2)]);               <span class="comment">%Find the new maximum for each trial.</span>
        s = median(double(diff(handles.trial(t).sample_times)));            <span class="comment">%Find the median inter-sample interval for each trial.</span>
        <span class="keyword">if</span> s == 0                                                           <span class="comment">%If all the inter-sample intervals are the same...</span>
            handles.trial(t).sample_times = <span class="keyword">...</span>
                (10*(1:length(handles.trial(t).signal)) - 1010)';           <span class="comment">%Use the sample times from a different trial in place of the bad times on the curren trial.</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    handles.cur_trial = 1;                                                  <span class="comment">%Set the current trial to 1.</span>
    handles.num_trials = length(handles.trial);                             <span class="comment">%Grab the number of trials.</span>
    handles = Make_GUI(handles);                                            <span class="comment">%Create the GUI.</span>
    ShowTrial(handles,handles.cur_trial);                                   <span class="comment">%Show the first trial.</span>
    set(handles.slider,<span class="string">'callback'</span>,@SliderClick);                            <span class="comment">%Set the callback for action on the slider.</span>
    set(handles.savebutton,<span class="string">'callback'</span>,@SavePlot);                           <span class="comment">%Set the callback for the save plot pushbutton.</span>
    guidata(handles.fig,handles);                                           <span class="comment">%Pin the handles structure to the GUI.</span>
<span class="keyword">end</span>
</pre><h2>This function displays the force and IR traces from the selected trial.<a name="3"></a></h2><pre class="codeinput"><span class="keyword">function</span> ShowTrial(handles,t)
</pre><pre class="codeinput">pos = get(handles.fig,<span class="string">'position'</span>);                                          <span class="comment">%Grab the main figure position.</span>
area(handles.trial(t).sample_times,handles.trial(t).ir,<span class="keyword">...</span>
    <span class="string">'linewidth'</span>,2,<span class="string">'facecolor'</span>,[1 0.5 0.5],<span class="string">'parent'</span>,handles.ir_axes,<span class="keyword">...</span>
    <span class="string">'basevalue'</span>,handles.ir_thresh(2));                                      <span class="comment">%Show the IR signal as an area plot.</span>
set(handles.ir_axes,<span class="string">'ylim'</span>,handles.ir_thresh,<span class="string">'ydir'</span>,<span class="string">'reverse'</span>,<span class="keyword">...</span>
    <span class="string">'xlim'</span>,handles.trial(t).sample_times([1,end]),<span class="string">'xticklabel'</span>,[],<span class="keyword">...</span>
    <span class="string">'ytick'</span>,[]);                                                            <span class="comment">%Set the IR axes properties.</span>
ylabel(<span class="string">'IR Signal'</span>,<span class="string">'parent'</span>,handles.ir_axes,<span class="string">'fontsize'</span>,0.75*pos(4),<span class="keyword">...</span>
    <span class="string">'rotation'</span>,0,<span class="string">'verticalalignment'</span>,<span class="string">'middle'</span>,<span class="keyword">...</span>
    <span class="string">'horizontalalignment'</span>,<span class="string">'right'</span>);                                         <span class="comment">%Label the IR signal.</span>
set(handles.label,<span class="string">'string'</span>,[<span class="string">'Subject: '</span> handles.rat <span class="string">', Trial '</span> <span class="keyword">...</span>
    num2str(t) <span class="string">'/'</span> num2str(handles.num_trials) <span class="string">', '</span> <span class="keyword">...</span>
    datestr(handles.trial(t).starttime,<span class="string">'HH:MM:SS, mm/dd/yy'</span>)],<span class="keyword">...</span>
    <span class="string">'fontsize'</span>,0.75*pos(4));                                                <span class="comment">%Update the trial label.</span>
area(handles.trial(t).sample_times,handles.trial(t).signal,<span class="keyword">...</span>
    <span class="string">'linewidth'</span>,2,<span class="string">'facecolor'</span>,[0.5 0.5 1],<span class="string">'parent'</span>,handles.force_axes);     <span class="comment">%Show the force signal as an area plot.</span>

<span class="comment">% [pks, sig] = Knob_Peak_Finder(handles.trial(t).signal);                     %find peaks</span>
<span class="comment">% set(sig, pks, '*r', 'parent', handles.force_axes);</span>

min_max = [min(handles.trial(t).signal), max(handles.trial(t).signal)];     <span class="comment">%Grab the minimum and maximum of the signal.</span>
set(handles.force_axes,<span class="string">'xlim'</span>,handles.trial(t).sample_times([1,end]),<span class="keyword">...</span>
    <span class="string">'ylim'</span>,min_max + [-0.05,0.1]*range(min_max),<span class="string">'fontsize'</span>,0.5*pos(4));     <span class="comment">%Set the force axes properties.</span>
line([0,0],min_max(2)+[0.02,0.08]*range(min_max),<span class="string">'color'</span>,<span class="string">'k'</span>,<span class="keyword">...</span>
    <span class="string">'parent'</span>,handles.force_axes,<span class="string">'linewidth'</span>,2);                             <span class="comment">%Draw a line to show the start of the hit window.</span>
line(1000*[1,1]*handles.trial(t).hitwin,<span class="keyword">...</span>
    min_max(2)+[0.02,0.08]*range(min_max),<span class="string">'color'</span>,<span class="string">'k'</span>,<span class="keyword">...</span>
    <span class="string">'parent'</span>,handles.force_axes,<span class="string">'linewidth'</span>,2);                             <span class="comment">%Draw a line to show the end of the hit window.</span>
line([0,1000*handles.trial(t).hitwin],<span class="keyword">...</span>
    min_max(2)+0.05*range(min_max)*[1,1],<span class="string">'color'</span>,<span class="string">'k'</span>,<span class="keyword">...</span>
    <span class="string">'parent'</span>,handles.force_axes,<span class="string">'linestyle'</span>,<span class="string">'--'</span>,<span class="string">'linewidth'</span>,2);            <span class="comment">%Draw a line to show the length of the hit window.</span>
text(500*handles.trial(t).hitwin,min_max(2)+0.05*range(min_max),<span class="keyword">...</span>
    <span class="string">'Hit Window'</span>,<span class="string">'margin'</span>,2,<span class="string">'edgecolor'</span>,<span class="string">'w'</span>,<span class="string">'backgroundcolor'</span>,<span class="string">'w'</span>,<span class="keyword">...</span>
    <span class="string">'fontsize'</span>,0.5*pos(4),<span class="string">'fontweight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
    <span class="string">'parent'</span>,handles.force_axes,<span class="string">'horizontalalignment'</span>,<span class="string">'center'</span>,<span class="keyword">...</span>
    <span class="string">'verticalalignment'</span>,<span class="string">'middle'</span>);                                          <span class="comment">%Label the hit window.</span>
a = line([0,0],get(handles.force_axes,<span class="string">'ylim'</span>),<span class="string">'color'</span>,[0.5 0.5 0.5],<span class="keyword">...</span>
    <span class="string">'parent'</span>,handles.force_axes,<span class="string">'linewidth'</span>,2,<span class="string">'linestyle'</span>,<span class="string">'--'</span>);            <span class="comment">%Draw a gray dotted line to show the start of the hit window.</span>
uistack(a,<span class="string">'bottom'</span>);                                                        <span class="comment">%Move the dotted line to the bottom of the stack.</span>
a = line(1000*[1,1]*handles.trial(t).hitwin,<span class="keyword">...</span>
    get(handles.force_axes,<span class="string">'ylim'</span>),<span class="string">'color'</span>,[0.5 0.5 0.5],<span class="keyword">...</span>
    <span class="string">'parent'</span>,handles.force_axes,<span class="string">'linewidth'</span>,2,<span class="string">'linestyle'</span>,<span class="string">'--'</span>);            <span class="comment">%Draw a gray dotted line to show the end of the hit window.</span>
uistack(a,<span class="string">'bottom'</span>);                                                        <span class="comment">%Move the dotted line to the bottom of the stack.</span>
<span class="keyword">if</span> max(get(handles.force_axes,<span class="string">'ylim'</span>)) &gt; handles.trial(t).init              <span class="comment">%If the y-axis scale is large enough to show the initiation threshold...</span>
    line([-100,max(get(handles.force_axes,<span class="string">'xlim'</span>))],<span class="keyword">...</span>
        handles.trial(t).init*[1,1],<span class="string">'color'</span>,[0 0.5 0],<span class="keyword">...</span>
        <span class="string">'parent'</span>,handles.force_axes,<span class="string">'linewidth'</span>,2,<span class="string">'linestyle'</span>,<span class="string">'--'</span>);        <span class="comment">%Draw a line showing the initiation threshold.</span>
    text(-100,handles.trial(t).init,<span class="string">'Initiation '</span>,<span class="string">'color'</span>,[0 0.5 0],<span class="keyword">...</span>
        <span class="string">'fontsize'</span>,0.5*pos(4),<span class="string">'fontweight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
        <span class="string">'parent'</span>,handles.force_axes,<span class="string">'horizontalalignment'</span>,<span class="string">'right'</span>,<span class="keyword">...</span>
        <span class="string">'verticalalignment'</span>,<span class="string">'middle'</span>);                                      <span class="comment">%Label the initiation threshold.</span>
<span class="keyword">end</span>
<span class="keyword">if</span> max(get(handles.force_axes,<span class="string">'ylim'</span>)) &gt; handles.trial(t).thresh            <span class="comment">%If the y-axis scale is large enough to show the hit threshold...</span>
    line([-100,max(get(handles.force_axes,<span class="string">'xlim'</span>))],<span class="keyword">...</span>
        handles.trial(t).thresh*[1,1],<span class="string">'color'</span>,[0.5 0 0],<span class="keyword">...</span>
        <span class="string">'parent'</span>,handles.force_axes,<span class="string">'linewidth'</span>,2,<span class="string">'linestyle'</span>,<span class="string">'--'</span>);        <span class="comment">%Draw a line showing the hit threshold.</span>
    text(-100,handles.trial(t).thresh,<span class="string">'Hit Threshold '</span>,<span class="keyword">...</span>
        <span class="string">'color'</span>,[0.5 0 0],<span class="string">'fontsize'</span>,0.5*pos(4),<span class="string">'fontweight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
        <span class="string">'parent'</span>,handles.force_axes,<span class="string">'horizontalalignment'</span>,<span class="string">'right'</span>,<span class="keyword">...</span>
        <span class="string">'verticalalignment'</span>,<span class="string">'middle'</span>);                                      <span class="comment">%Label the hit threshold.</span>
<span class="keyword">end</span>
ylabel(<span class="string">'Angle (degrees)'</span>,<span class="string">'parent'</span>,handles.force_axes,<span class="string">'fontsize'</span>,0.75*pos(4));<span class="comment">%Label the force signal.</span>
xlabel(<span class="string">'Time (ms)'</span>,<span class="string">'parent'</span>,handles.force_axes,<span class="string">'fontsize'</span>,0.75*pos(4));     <span class="comment">%Label the time axis.</span>
</pre><h2>This function executes when the user interacts with the slider.<a name="6"></a></h2><pre class="codeinput"><span class="keyword">function</span> SliderClick(hObject,~)
</pre><pre class="codeinput">handles = guidata(hObject);                                                 <span class="comment">%Grab the handles structure from the GUI.</span>
handles.cur_trial = round(get(hObject,<span class="string">'value'</span>));                            <span class="comment">%Set the current trial to the value of the slider.</span>
<span class="keyword">if</span> handles.cur_trial &lt; 1                                                    <span class="comment">%If the current trial is less than 1...</span>
    handles.cur_trial = 1;                                                  <span class="comment">%Set the current trial to 1.</span>
<span class="keyword">elseif</span> handles.cur_trial &gt; handles.num_trials                               <span class="comment">%Otherwise, if the current trials is greater than the total number of trials.</span>
    handles.cur_trial = handles.num_trials;                                 <span class="comment">%Set the current trial to the last trial.</span>
<span class="keyword">end</span>
set(hObject,<span class="string">'value'</span>,handles.cur_trial);                                     <span class="comment">%Update the value of the slider.</span>
ShowTrial(handles,handles.cur_trial);                                       <span class="comment">%Show the current trial.</span>
guidata(hObject,handles);                                                   <span class="comment">%Pin the handles structure back to the GUI.</span>
</pre><h2>This function executes when the user interacts with the slider.<a name="9"></a></h2><pre class="codeinput"><span class="keyword">function</span> SavePlot(hObject,~)
</pre><pre class="codeinput">handles = guidata(hObject);                                                 <span class="comment">%Grab the handles structure from the GUI.</span>
filename = [handles.file(1:end-10) <span class="string">'_TRIAL'</span> <span class="keyword">...</span>
    num2str(handles.cur_trial,<span class="string">'%03.0f'</span>) <span class="string">'.png'</span>];                            <span class="comment">%Create a default filename for the PNG file.</span>
[filename, path] = uiputfile(<span class="string">'*.png'</span>,<span class="string">'Name Image File'</span>,filename);           <span class="comment">%Ask the user for a new filename.</span>
<span class="keyword">if</span> filename(1) == 0                                                         <span class="comment">%If the user selected cancel...</span>
    <span class="keyword">return</span>                                                                  <span class="comment">%Exit the function.</span>
<span class="keyword">end</span>
set([handles.slider,handles.savebutton],<span class="string">'visible'</span>,<span class="string">'off'</span>,<span class="string">'enable'</span>,<span class="string">'off'</span>);    <span class="comment">%Make the uicontrols invisible and disable them.</span>
<span class="comment">% fix_dotted_line_export(handles.force_axes);                                 %Fix the dotted lines in the force axes.</span>
pos = get(handles.fig,<span class="string">'position'</span>);                                          <span class="comment">%Grab the figure position.</span>
temp = get(handles.fig,<span class="string">'color'</span>);                                            <span class="comment">%Grab the starting color of the figure.</span>
set(handles.fig,<span class="string">'paperpositionmode'</span>,<span class="string">'auto'</span>,<span class="keyword">...</span>
    <span class="string">'inverthardcopy'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'paperunits'</span>,get(handles.fig,<span class="string">'units'</span>),<span class="keyword">...</span>
    <span class="string">'papersize'</span>,pos(3:4),<span class="keyword">...</span>
    <span class="string">'color'</span>,<span class="string">'w'</span>);                                                           <span class="comment">%Set the figure properties for printing.</span>
set(handles.label,<span class="string">'backgroundcolor'</span>,<span class="string">'w'</span>);                                   <span class="comment">%Set the label background color to white.</span>
drawnow;                                                                    <span class="comment">%Immediately update the figure.</span>
print(gcf,[path, filename],<span class="string">'-dpng'</span>,<span class="string">'-r300'</span>);                                <span class="comment">%Save the current image as a PNG file.</span>
set([handles.slider,handles.savebutton],<span class="string">'visible'</span>,<span class="string">'on'</span>,<span class="string">'enable'</span>,<span class="string">'on'</span>);      <span class="comment">%Make the uicontrols visible and enabled again.</span>
set(handles.fig,<span class="string">'color'</span>,temp);                                              <span class="comment">%Reset the figure color to the original color.</span>
set(handles.label,<span class="string">'backgroundcolor'</span>,temp);                                  <span class="comment">%Set the label background color to the original color.</span>
</pre><h2>This subfunction creates the GUI.<a name="12"></a></h2><pre class="codeinput"><span class="keyword">function</span> handles = Make_GUI(handles)
</pre><pre class="codeinput">set(0,<span class="string">'units'</span>,<span class="string">'centimeters'</span>);                                               <span class="comment">%Set the system units to centimeters.</span>
pos = get(0,<span class="string">'screensize'</span>);                                                  <span class="comment">%Grab the screen size.</span>
h = 0.8*pos(4);                                                             <span class="comment">%Calculate the height of the figure.</span>
w = 4*h/3;                                                                  <span class="comment">%Scale the width of the figure to the height.</span>
handles.fig = figure(<span class="string">'MenuBar'</span>,<span class="string">'none'</span>,<span class="keyword">...</span>
    <span class="string">'numbertitle'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
    <span class="string">'name'</span>,[<span class="string">'Pull Viewer: '</span> handles.file],<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'centimeters'</span>,<span class="keyword">...</span>
    <span class="string">'resize'</span>,<span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'ResizeFcn'</span>,@Resize,<span class="keyword">...</span>
    <span class="string">'Position'</span>,[pos(3)/2-w/2, pos(4)/2-h/2, w, h]);                         <span class="comment">%Create a figure.</span>
handles.label =  uicontrol(handles.fig,<span class="string">'style'</span>,<span class="string">'text'</span>,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'position'</span>,[0.01,0.95,0.98,0.04],<span class="keyword">...</span>
    <span class="string">'string'</span>,[],<span class="keyword">...</span>
    <span class="string">'fontsize'</span>,0.5*h,<span class="keyword">...</span>
    <span class="string">'backgroundcolor'</span>,get(handles.fig,<span class="string">'color'</span>),<span class="keyword">...</span>
    <span class="string">'horizontalalignment'</span>,<span class="string">'left'</span>,<span class="keyword">...</span>
    <span class="string">'fontweight'</span>,<span class="string">'bold'</span>);                                                   <span class="comment">%Create a text label for showing the trial number and time.</span>
handles.ir_axes = axes(<span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'position'</span>,[0.1,0.85,0.89,0.09],<span class="keyword">...</span>
    <span class="string">'box'</span>,<span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'linewidth'</span>,2);                                                         <span class="comment">%Create axes for showing the IR signal.</span>
handles.force_axes = axes(<span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'position'</span>,[0.1,0.12,0.89,0.72],<span class="keyword">...</span>
    <span class="string">'box'</span>,<span class="string">'on'</span>,<span class="keyword">...</span>
    <span class="string">'linewidth'</span>,2);                                                         <span class="comment">%Create axes for showing the IR signal.</span>
handles.slider = uicontrol(handles.fig,<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'position'</span>,[0.01,0.01,0.78,0.04],<span class="keyword">...</span>
    <span class="string">'value'</span>,1,<span class="keyword">...</span>
    <span class="string">'min'</span>,1,<span class="keyword">...</span>
    <span class="string">'max'</span>,handles.num_trials,<span class="keyword">...</span>
    <span class="string">'SliderStep'</span>,[1/handles.num_trials, 0.1]);                              <span class="comment">%Create a trial slider.</span>
handles.savebutton = uicontrol(handles.fig,<span class="string">'style'</span>,<span class="string">'pushbutton'</span>,<span class="keyword">...</span>
    <span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="keyword">...</span>
    <span class="string">'position'</span>,[0.80,0.01,0.19,0.04],<span class="keyword">...</span>
    <span class="string">'string'</span>,<span class="string">'Save Plot (PNG)'</span>,<span class="keyword">...</span>
    <span class="string">'fontsize'</span>,0.75*h);                                                     <span class="comment">%Create a button for saving a plot image.</span>
</pre><h2>This function is called whenever the main figure is resized.<a name="15"></a></h2><pre class="codeinput"><span class="keyword">function</span> Resize(hObject,~)
</pre><pre class="codeinput">handles = guidata(hObject);                                                 <span class="comment">%Grab the handles structure from the GUI.</span>
pos = get(handles.fig,<span class="string">'position'</span>);                                          <span class="comment">%Grab the main figure position.</span>
ylabel(<span class="string">'IR Signal'</span>,<span class="string">'parent'</span>,handles.ir_axes,<span class="string">'fontsize'</span>,0.75*pos(4),<span class="keyword">...</span>
    <span class="string">'rotation'</span>,0,<span class="string">'verticalalignment'</span>,<span class="string">'middle'</span>,<span class="keyword">...</span>
    <span class="string">'horizontalalignment'</span>,<span class="string">'right'</span>);                                         <span class="comment">%Label the IR signal with the new fontsize.</span>
set([handles.label,handles.savebutton],<span class="string">'fontsize'</span>,0.75*pos(4));             <span class="comment">%Update the trial label and savebutton fontsize.</span>
objs = get(handles.force_axes,<span class="string">'children'</span>);                                  <span class="comment">%Grab all children of the force axes.</span>
objs(~strcmpi(<span class="string">'text'</span>,get(objs,<span class="string">'type'</span>))) = [];                               <span class="comment">%Kick out all non-text objects.</span>
set(objs,<span class="string">'fontsize'</span>,0.5*pos(4));                                            <span class="comment">%Update the fontsize of all text objects.</span>
ylabel(<span class="string">'Angle (degrees)'</span>,<span class="string">'parent'</span>,handles.force_axes,<span class="string">'fontsize'</span>,0.75*pos(4));     <span class="comment">%Label the force signal.</span>
xlabel(<span class="string">'Time (ms)'</span>,<span class="string">'parent'</span>,handles.force_axes,<span class="string">'fontsize'</span>,0.75*pos(4));     <span class="comment">%Label the time axis.</span>
</pre><h2>This function finds peaks in the signal, accounting for equality of contiguous samples.<a name="18"></a></h2><pre class="codeinput"><span class="keyword">function</span> [pks, sig] = Knob_Peak_Finder(signal)
    <span class="comment">%This code finds and kicks out peaks that have a std dev between</span>
    <span class="comment">%them less than 1</span>

    smoothed_signal = boxsmooth(signal);                                        <span class="comment">%smooth out the trial signal</span>
    [pks, sig] = findpeaks(smoothed_signal, <span class="string">'MINPEAKHEIGHT'</span>, 5, <span class="keyword">...</span>
        <span class="string">'MINPEAKDISTANCE'</span>, 10);                                            <span class="comment">%Find local maximma</span>
    n = length(pks);
    j = 1;
    <span class="keyword">if</span> n&gt;1
        <span class="keyword">while</span> j &lt;= n-1
            <span class="keyword">if</span> (abs(pks(j)-pks(j+1)) &lt;= 5)                                 <span class="comment">% if the diff between 2 peaks is less than or equal to 5</span>
                start_sig = sig(j);
                end_sig = sig(j+1);

                signal_interest = smoothed_signal(start_sig:end_sig);
                deviation_signal = std(signal_interest);

                <span class="keyword">if</span> deviation_signal &lt; 1
                    pks(j+1) = [];
                    sig(j+1) = [];
                    j = j-1;
                <span class="keyword">end</span>

            <span class="keyword">end</span>
            n = length(pks);
            j = j+1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015a</a><br></p></div><!--
##### SOURCE BEGIN #####
function MotoTrak_Supination_Viewer

[files, path] = uigetfile('*.ArdyMotor','Select MotoTrak Files',...
    'multiselect','on');                                                    %Have the user pick an input *.ArdyMotor file or files.
if ~iscell(files) && files(1) == 0                                          %If no file was selected...
    return                                                                  %Exit the function.
end
cd(path);                                                                   %Change the current directory to the specified folder.
if ischar(files)                                                            %If only one file was selected...
    files = {files};                                                        %Convert the string to a cell array.
end

for f = 1:length(files)                                                     %Step through each file.
    handles = ArdyMotorFileRead(files{f});                                  %Read in the data from the *.ArdyMotor file.
    if ~isfield(handles,'trial') || isempty(handles.trial)                  %If there's no trials in this data file...
        warning('ARDYMOTOR2TEXT:NoTrials',['WARNING FROM '...
            'ARDYMOTOR2TEXT: The file "' files{f} '" has zero trials '...
            'and will be skipped.']);                                       %Show a warning.
        continue                                                            %Skip to the next file.
    end
    handles.file = files{f};                                                %Save the filename.
    handles.ir_thresh = [1023, 0];                                          %Create a matrix to hold the IR signal bounds.
    for t = 1:length(handles.trial)                                         %Step through each trial.
        handles.ir_thresh(1) = ...
            min([handles.trial(t).ir; handles.ir_thresh(1)]);               %Find the new minimum for each trial.
        handles.ir_thresh(2) = ...
            max([handles.trial(t).ir; handles.ir_thresh(2)]);               %Find the new maximum for each trial.
        s = median(double(diff(handles.trial(t).sample_times)));            %Find the median inter-sample interval for each trial.
        if s == 0                                                           %If all the inter-sample intervals are the same...
            handles.trial(t).sample_times = ...
                (10*(1:length(handles.trial(t).signal)) - 1010)';           %Use the sample times from a different trial in place of the bad times on the curren trial.
        end
    end
    handles.cur_trial = 1;                                                  %Set the current trial to 1.
    handles.num_trials = length(handles.trial);                             %Grab the number of trials.
    handles = Make_GUI(handles);                                            %Create the GUI.
    ShowTrial(handles,handles.cur_trial);                                   %Show the first trial.
    set(handles.slider,'callback',@SliderClick);                            %Set the callback for action on the slider.
    set(handles.savebutton,'callback',@SavePlot);                           %Set the callback for the save plot pushbutton.
    guidata(handles.fig,handles);                                           %Pin the handles structure to the GUI.
end


%% This function displays the force and IR traces from the selected trial.
function ShowTrial(handles,t)
pos = get(handles.fig,'position');                                          %Grab the main figure position.
area(handles.trial(t).sample_times,handles.trial(t).ir,...
    'linewidth',2,'facecolor',[1 0.5 0.5],'parent',handles.ir_axes,...
    'basevalue',handles.ir_thresh(2));                                      %Show the IR signal as an area plot.
set(handles.ir_axes,'ylim',handles.ir_thresh,'ydir','reverse',...
    'xlim',handles.trial(t).sample_times([1,end]),'xticklabel',[],...
    'ytick',[]);                                                            %Set the IR axes properties.
ylabel('IR Signal','parent',handles.ir_axes,'fontsize',0.75*pos(4),...
    'rotation',0,'verticalalignment','middle',...
    'horizontalalignment','right');                                         %Label the IR signal.
set(handles.label,'string',['Subject: ' handles.rat ', Trial ' ...
    num2str(t) '/' num2str(handles.num_trials) ', ' ...
    datestr(handles.trial(t).starttime,'HH:MM:SS, mm/dd/yy')],...
    'fontsize',0.75*pos(4));                                                %Update the trial label.
area(handles.trial(t).sample_times,handles.trial(t).signal,...
    'linewidth',2,'facecolor',[0.5 0.5 1],'parent',handles.force_axes);     %Show the force signal as an area plot.

% [pks, sig] = Knob_Peak_Finder(handles.trial(t).signal);                     %find peaks
% set(sig, pks, '*r', 'parent', handles.force_axes);

min_max = [min(handles.trial(t).signal), max(handles.trial(t).signal)];     %Grab the minimum and maximum of the signal.
set(handles.force_axes,'xlim',handles.trial(t).sample_times([1,end]),...
    'ylim',min_max + [-0.05,0.1]*range(min_max),'fontsize',0.5*pos(4));     %Set the force axes properties.
line([0,0],min_max(2)+[0.02,0.08]*range(min_max),'color','k',...
    'parent',handles.force_axes,'linewidth',2);                             %Draw a line to show the start of the hit window.
line(1000*[1,1]*handles.trial(t).hitwin,...
    min_max(2)+[0.02,0.08]*range(min_max),'color','k',...
    'parent',handles.force_axes,'linewidth',2);                             %Draw a line to show the end of the hit window.
line([0,1000*handles.trial(t).hitwin],...
    min_max(2)+0.05*range(min_max)*[1,1],'color','k',...
    'parent',handles.force_axes,'linestyle','REPLACE_WITH_DASH_DASH','linewidth',2);            %Draw a line to show the length of the hit window.
text(500*handles.trial(t).hitwin,min_max(2)+0.05*range(min_max),...
    'Hit Window','margin',2,'edgecolor','w','backgroundcolor','w',...
    'fontsize',0.5*pos(4),'fontweight','bold',...
    'parent',handles.force_axes,'horizontalalignment','center',...
    'verticalalignment','middle');                                          %Label the hit window.
a = line([0,0],get(handles.force_axes,'ylim'),'color',[0.5 0.5 0.5],...
    'parent',handles.force_axes,'linewidth',2,'linestyle','REPLACE_WITH_DASH_DASH');            %Draw a gray dotted line to show the start of the hit window.
uistack(a,'bottom');                                                        %Move the dotted line to the bottom of the stack.
a = line(1000*[1,1]*handles.trial(t).hitwin,...
    get(handles.force_axes,'ylim'),'color',[0.5 0.5 0.5],...
    'parent',handles.force_axes,'linewidth',2,'linestyle','REPLACE_WITH_DASH_DASH');            %Draw a gray dotted line to show the end of the hit window.
uistack(a,'bottom');                                                        %Move the dotted line to the bottom of the stack.
if max(get(handles.force_axes,'ylim')) > handles.trial(t).init              %If the y-axis scale is large enough to show the initiation threshold...
    line([-100,max(get(handles.force_axes,'xlim'))],...
        handles.trial(t).init*[1,1],'color',[0 0.5 0],...
        'parent',handles.force_axes,'linewidth',2,'linestyle','REPLACE_WITH_DASH_DASH');        %Draw a line showing the initiation threshold.
    text(-100,handles.trial(t).init,'Initiation ','color',[0 0.5 0],...
        'fontsize',0.5*pos(4),'fontweight','bold',...
        'parent',handles.force_axes,'horizontalalignment','right',...
        'verticalalignment','middle');                                      %Label the initiation threshold.
end
if max(get(handles.force_axes,'ylim')) > handles.trial(t).thresh            %If the y-axis scale is large enough to show the hit threshold...
    line([-100,max(get(handles.force_axes,'xlim'))],...
        handles.trial(t).thresh*[1,1],'color',[0.5 0 0],...
        'parent',handles.force_axes,'linewidth',2,'linestyle','REPLACE_WITH_DASH_DASH');        %Draw a line showing the hit threshold.
    text(-100,handles.trial(t).thresh,'Hit Threshold ',...
        'color',[0.5 0 0],'fontsize',0.5*pos(4),'fontweight','bold',...
        'parent',handles.force_axes,'horizontalalignment','right',...
        'verticalalignment','middle');                                      %Label the hit threshold.
end
ylabel('Angle (degrees)','parent',handles.force_axes,'fontsize',0.75*pos(4));%Label the force signal.
xlabel('Time (ms)','parent',handles.force_axes,'fontsize',0.75*pos(4));     %Label the time axis.


%% This function executes when the user interacts with the slider.
function SliderClick(hObject,~)
handles = guidata(hObject);                                                 %Grab the handles structure from the GUI.
handles.cur_trial = round(get(hObject,'value'));                            %Set the current trial to the value of the slider.
if handles.cur_trial < 1                                                    %If the current trial is less than 1...
    handles.cur_trial = 1;                                                  %Set the current trial to 1.
elseif handles.cur_trial > handles.num_trials                               %Otherwise, if the current trials is greater than the total number of trials.
    handles.cur_trial = handles.num_trials;                                 %Set the current trial to the last trial.
end
set(hObject,'value',handles.cur_trial);                                     %Update the value of the slider.
ShowTrial(handles,handles.cur_trial);                                       %Show the current trial.
guidata(hObject,handles);                                                   %Pin the handles structure back to the GUI.


%% This function executes when the user interacts with the slider.
function SavePlot(hObject,~)
handles = guidata(hObject);                                                 %Grab the handles structure from the GUI.
filename = [handles.file(1:end-10) '_TRIAL' ...
    num2str(handles.cur_trial,'%03.0f') '.png'];                            %Create a default filename for the PNG file.
[filename, path] = uiputfile('*.png','Name Image File',filename);           %Ask the user for a new filename.
if filename(1) == 0                                                         %If the user selected cancel...
    return                                                                  %Exit the function.
end
set([handles.slider,handles.savebutton],'visible','off','enable','off');    %Make the uicontrols invisible and disable them.
% fix_dotted_line_export(handles.force_axes);                                 %Fix the dotted lines in the force axes.
pos = get(handles.fig,'position');                                          %Grab the figure position.
temp = get(handles.fig,'color');                                            %Grab the starting color of the figure.
set(handles.fig,'paperpositionmode','auto',...
    'inverthardcopy','off',...
    'paperunits',get(handles.fig,'units'),...
    'papersize',pos(3:4),...
    'color','w');                                                           %Set the figure properties for printing.
set(handles.label,'backgroundcolor','w');                                   %Set the label background color to white.
drawnow;                                                                    %Immediately update the figure.
print(gcf,[path, filename],'-dpng','-r300');                                %Save the current image as a PNG file.
set([handles.slider,handles.savebutton],'visible','on','enable','on');      %Make the uicontrols visible and enabled again.
set(handles.fig,'color',temp);                                              %Reset the figure color to the original color.
set(handles.label,'backgroundcolor',temp);                                  %Set the label background color to the original color.


%% This subfunction creates the GUI.
function handles = Make_GUI(handles)
set(0,'units','centimeters');                                               %Set the system units to centimeters.
pos = get(0,'screensize');                                                  %Grab the screen size.
h = 0.8*pos(4);                                                             %Calculate the height of the figure.
w = 4*h/3;                                                                  %Scale the width of the figure to the height.
handles.fig = figure('MenuBar','none',...
    'numbertitle','off',...
    'name',['Pull Viewer: ' handles.file],...
    'units','centimeters',...
    'resize','on',...
    'ResizeFcn',@Resize,...
    'Position',[pos(3)/2-w/2, pos(4)/2-h/2, w, h]);                         %Create a figure.
handles.label =  uicontrol(handles.fig,'style','text',...
    'units','normalized',...
    'position',[0.01,0.95,0.98,0.04],...
    'string',[],...
    'fontsize',0.5*h,...
    'backgroundcolor',get(handles.fig,'color'),...
    'horizontalalignment','left',...
    'fontweight','bold');                                                   %Create a text label for showing the trial number and time.
handles.ir_axes = axes('units','normalized',...
    'position',[0.1,0.85,0.89,0.09],...
    'box','on',...
    'linewidth',2);                                                         %Create axes for showing the IR signal.
handles.force_axes = axes('units','normalized',...
    'position',[0.1,0.12,0.89,0.72],...
    'box','on',...
    'linewidth',2);                                                         %Create axes for showing the IR signal.
handles.slider = uicontrol(handles.fig,'style','slider',...
    'units','normalized',...
    'position',[0.01,0.01,0.78,0.04],...
    'value',1,...
    'min',1,...
    'max',handles.num_trials,...
    'SliderStep',[1/handles.num_trials, 0.1]);                              %Create a trial slider.
handles.savebutton = uicontrol(handles.fig,'style','pushbutton',...
    'units','normalized',...
    'position',[0.80,0.01,0.19,0.04],...
    'string','Save Plot (PNG)',...
    'fontsize',0.75*h);                                                     %Create a button for saving a plot image.


%% This function is called whenever the main figure is resized.
function Resize(hObject,~)
handles = guidata(hObject);                                                 %Grab the handles structure from the GUI.
pos = get(handles.fig,'position');                                          %Grab the main figure position.
ylabel('IR Signal','parent',handles.ir_axes,'fontsize',0.75*pos(4),...
    'rotation',0,'verticalalignment','middle',...
    'horizontalalignment','right');                                         %Label the IR signal with the new fontsize.
set([handles.label,handles.savebutton],'fontsize',0.75*pos(4));             %Update the trial label and savebutton fontsize.
objs = get(handles.force_axes,'children');                                  %Grab all children of the force axes.
objs(~strcmpi('text',get(objs,'type'))) = [];                               %Kick out all non-text objects.
set(objs,'fontsize',0.5*pos(4));                                            %Update the fontsize of all text objects.
ylabel('Angle (degrees)','parent',handles.force_axes,'fontsize',0.75*pos(4));     %Label the force signal.
xlabel('Time (ms)','parent',handles.force_axes,'fontsize',0.75*pos(4));     %Label the time axis.

%% This function finds peaks in the signal, accounting for equality of contiguous samples.
function [pks, sig] = Knob_Peak_Finder(signal)
    %This code finds and kicks out peaks that have a std dev between 
    %them less than 1
    
    smoothed_signal = boxsmooth(signal);                                        %smooth out the trial signal
    [pks, sig] = findpeaks(smoothed_signal, 'MINPEAKHEIGHT', 5, ...
        'MINPEAKDISTANCE', 10);                                            %Find local maximma
    n = length(pks);
    j = 1;
    if n>1
        while j <= n-1
            if (abs(pks(j)-pks(j+1)) <= 5)                                 % if the diff between 2 peaks is less than or equal to 5
                start_sig = sig(j);
                end_sig = sig(j+1);

                signal_interest = smoothed_signal(start_sig:end_sig);
                deviation_signal = std(signal_interest);

                if deviation_signal < 1
                    pks(j+1) = [];
                    sig(j+1) = [];
                    j = j-1;
                end

            end
            n = length(pks);
            j = j+1;
        end
    end


##### SOURCE END #####
--></body></html>